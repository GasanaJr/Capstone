<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="resp.css">
    <link rel="stylesheet" href="queries.css">
    <title>Admin Portal</title>
</head>
<body>
    <header>
		<a href="#" class="logo"><span>DJ</span></a>

		<ul class="navbar">
			<li><a href="admin.html">Home</a></li>
            <li><a href="queries.html">Questions</a></li>
            <li><a href="article.html">Articles</a></li>
            <li><a href="post.html">Posts</a></li>
		</ul>

		<div class="main">
			<div class="bx bx-menu" id="menu-icon"></div>
		</div>
	</header>
    <div>
        <table>
    <thead>
        <th>Email</th>
        <th>Full Name</th>
        <th>Content</th>
        <th>Action</th>
    </thead>
   <tbody>
   </tbody>
   </table>
        </div>
    <div id="table"></div>
    <script>
        const token = localStorage.getItem('auth-token');
        fetch('https://junior-capstone-backend.onrender.com/message', {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "auth-token": token
            }
        })
        .then(res => {
            return res.json();
        })
        .then(data => {
            data.forEach(message => {
            var table = document.querySelector('table');
            var tbody = document.querySelector('tbody');
            tbody.innerHTML += `
                 <td>${message.email}</td>
                 <td>${message.name}</td>
                 <td>${message.content}</td>
                 <td><button class="button Green" id="edit"><a href="#">Reply</a></button> </td>
                 <td><button class="button Red delete-msg" data-id = "${message._id}"><a href="#">Delete</a></button> </td>
                 `;
                 
            });    
        })
        .then(()=> getDeleteItem());

        function getDeleteItem() {
            const deleteBtn = [...document.getElementsByClassName('delete-msg')];
            console.log(deleteBtn);
            deleteBtn.forEach(button => {
                //console.log(button.dataset.id);
                button.addEventListener('click', () => {
                    const deleteId = button.dataset.id;
                    //console.log(deleteId);
                    deleteMessage(deleteId);
                })
            })
        }

        async function deleteMessage(deleteId) {
            console.log(deleteId);
            const token = localStorage.getItem('auth-token'); 
             try {
                 const result = await fetch('http://localhost:3000/message/' + deleteId, {
                     method: "DELETE",
                     headers: {
                         "Content-Type": "application/json",
                         "auth-token": token,
                     }
                 });
                 const data = await result.json();
                 if(result.status == 200) {
                    swal(data.Message, "Message Deleted!", "success")
                 location.reload();
                 }
                 else {
                    swal(data.Message, "Check Error", "error")
                 }
             } catch (error) {
                console.log(error);
                
             }
        }



        
    //     const btn = document.getElementById('data');
    //  btn.addEventListener('click', (e) => {
    //     e.preventDefault();
    //     async () => {
    //         const data = await fetch('http://localhost:3000/message', {
    //             method: 'GET'
    //         }).then((res) => res.json());
    //     console.log(data);
        // const message = JSON.parse(data);
        //     
        //     // var row = document.createElement('tr');
        //     // var td = document.createElement('td');
        //     for (let i =0; i< message.length; i++) {
        //         tbody.innerHTML += `
        //         <td>${message[i].email}</td>
        //         <td>${message[i].name}</td>
        //         <td>${message[i].content}</td>
        //         <td><button class="button Green" id="edit"><a href="#">Reply</a></button> </td>
        //         <td><button class="button Red" id="delete" onclick="deleteItem(${message[i].id})"><a href="#">Delete</a></button> </td>
        //         `;

           // }
    //     }
    //  })
        // document.querySelector('tbody').addEventListener('click', function(e){
        //     e.preventDefault();
        //     var target = e.target;
        //     if(target.classList.contains('delete')) {
        //         target.parentElement.parentElement.remove();
        //     }
        // });
    </script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    
</body>
</html>